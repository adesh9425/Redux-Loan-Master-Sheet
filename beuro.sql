
select user_id,	max(date_of_last_payment),	sum(high_credit_sanctioned),	sum(amtcurrent),	sum(overdue),	max(dpd)
from (
select distinct v.user_id ,ls.loan_id, max(last_payment_date) filter(where last_payment_date is not null) over(partition by ls.loan_id ) 
as Date_of_Last_Payment,
sum(principal_due) over(partition by ls.loan_id) as High_Credit_Sanctioned,
sum(principal_due) filter(where payment_status='UnPaid') over(partition by ls.loan_id )  as AmtCurrent,
sum(principal_due) filter(where payment_status='UnPaid'  and due_date::date <'2023-03-01' ) over(partition by ls.loan_id )   as overdue ,
 now()::date  -min(due_date) filter(where last_payment_date is null) over(partition by ls.loan_id)  as dpd
from loan_schedule ls
join v3_loans v on v.id=ls.loan_id  
where v.user_id in (2129804,2417733,2418418,2419757,2420201,2420901,2421556,2421970,2422139,2424043,2424467,2424588,2427125,2427357,2428117,2429139,2429172,2430238,2432256,2432556,2433950,2434670,2435808,2435982,2436496,2438705,2438736,2438794,2439397,2440838,2441352,2441443,2441611,2442618,2443549,2444844,2446607,2447166,2447334,2448143,2448874,2449780,2450944,2454617,2455299,2455340,2455448,2455950,2456251,2456771,2457422,2457620,2457672,2458289,2458439,2458593,2458648,2459068,2459119,2459233,2460660,2460716,2460793,2460870,2461127,2461137,2461552,2461600,2461924,2462198,2462381,2462494,2462635,2462741,2463646,2465493,2466255,2466790,2467567,2467674,2468305,2469344,2469482,271171,892634,2514960,2516030,2519078,2521072,2522875,2526781,2530943,2536843,2540139,2542291,2544279,2546884,2552325,2559609,2561668,2565650,2570916,2570974,2571525,2571969,2574037,2576362,2576809,2576966,2578219,2579437,2584322,2585012,2590156,2590281,2592168,2593068,2594388,2607265,2607942,2608686,2608798,2609596,2610780,2611290,2611418,2611540,1547939,2421054,443213,2462945,2465518,2450594,2346591,2465127,2346300,2465286,2463536,2470277,2462882,2463388,2469730,2474128,2465461,2457797,2470163,2465950,2470310,2471842,2465619,2475527,2379398,2457767,2474148,2474520,2473753,2474085,2467156,2469642,2471245,2476642,2474750,2478025,2464340,2471428,2457833,2459502,2476110,1298864,2471283,2484095,2478187,2477043,2525343,2533410,2559489,2584353,2589400,2625133,2525394,2528587,2538828,2540837,2543387,2545597,2546389,2549163,2552235,2552679,2553962,2557775,2562493,2575462,2583829,2571293,2564339,2566869,2570166,2629400)
and ls.bill_id is null
order by 1,2
)k group by 1
